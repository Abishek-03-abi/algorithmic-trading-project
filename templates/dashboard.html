<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nubra Algo Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 10px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .metric-card { text-align: center; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
        .metric-value { font-size: 1.5rem; font-weight: bold; margin: 10px 0; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .navbar-brand { font-weight: bold; font-size: 1.5rem; }
        .section-title { color: #667eea; border-left: 4px solid #667eea; padding-left: 10px; }
        .btn-nubra { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; }
        .advanced-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <a class="navbar-brand" href="/">
                üìä NUBRA Algorithmic Trading Platform
            </a>
            <span class="navbar-text">Live Demo - Advanced Analytics Dashboard</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Control Panel -->
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5>üéØ Trading Strategy Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label"><strong>Select Stock:</strong></label>
                        <select class="form-select" id="stockSelect">
                            {% for symbol, name in stocks.items() %}
                            <option value="{{ symbol }}">{{ name }} ({{ symbol }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Trading Strategy:</strong></label>
                        <select class="form-select" id="strategySelect">
                            <option value="moving_average">üìà Moving Average Crossover</option>
                            <option value="rsi">üîÅ RSI Mean Reversion</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Time Period:</strong></label>
                        <select class="form-select" id="periodSelect">
                            <option value="1mo">1 Month</option>
                            <option value="3mo" selected>3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><strong>Initial Capital:</strong></label>
                        <div class="input-group">
                            <span class="input-group-text">‚Çπ</span>
                            <input type="number" class="form-control" id="initialCapital" value="100000">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-nubra btn-lg" onclick="runBacktest()">
                            üöÄ Execute Backtest
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row" id="metricsRow">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h6>üí∞ Total Return</h6>
                        <div class="metric-value positive" id="metricReturn">0%</div>
                        <small class="text-muted">Strategy Performance</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h6>‚öñÔ∏è Sharpe Ratio</h6>
                        <div class="metric-value" id="metricSharpe">0.00</div>
                        <small class="text-muted">Risk-Adjusted Return</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h6>üìâ Max Drawdown</h6>
                        <div class="metric-value negative" id="metricDrawdown">0%</div>
                        <small class="text-muted">Maximum Loss</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h6>üíµ Final Value</h6>
                        <div class="metric-value" id="metricFinal">‚Çπ0</div>
                        <small class="text-muted">Portfolio Value</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Charts Row -->
        <div class="row">
            <!-- Price Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="section-title">üìà Price Chart with Moving Averages</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RSI Gauge Chart -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="section-title">üå°Ô∏è RSI Momentum Gauge</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="rsiGaugeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section - NOW VISIBLE BY DEFAULT -->
        <div class="advanced-section">
            <h4 class="section-title">üìä Advanced Analytics</h4>
            
            <div class="row">
                <!-- Strategy Performance -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="section-title">üèÜ Strategy vs Buy & Hold</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="strategyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Returns Distribution -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="section-title">üìà Daily Returns Distribution</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="returnsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <!-- Win/Loss Pie Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="section-title">ü•ß Win/Loss Ratio Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Performance -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="section-title">üìÖ Monthly Performance</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Signals -->
        <div class="card">
            <div class="card-header">
                <h6 class="section-title">üìã Trade Execution Signals & Analysis</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tradeTable">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Signal</th>
                                <th>Price (‚Çπ)</th>
                                <th>RSI</th>
                                <th>Market Condition</th>
                                <th>Return %</th>
                            </tr>
                        </thead>
                        <tbody id="tradeTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Run backtest to see trade signals...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Risk Analysis Summary -->
        <div class="card">
            <div class="card-header">
                <h6 class="section-title">üõ°Ô∏è Risk Analysis Summary</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <h5>üìè Volatility</h5>
                        <div class="metric-value" id="riskVolatility">0%</div>
                        <small>Annualized</small>
                    </div>
                    <div class="col-md-2">
                        <h5>üéØ Win Rate</h5>
                        <div class="metric-value positive" id="riskWinRate">0%</div>
                        <small>Successful Trades</small>
                    </div>
                    <div class="col-md-2">
                        <h5>‚ö° Profit Factor</h5>
                        <div class="metric-value" id="riskProfitFactor">0.0</div>
                        <small>Gain/Loss Ratio</small>
                    </div>
                    <div class="col-md-2">
                        <h5>üìä Expectancy</h5>
                        <div class="metric-value" id="riskExpectancy">0.0</div>
                        <small>Per Trade</small>
                    </div>
                    <div class="col-md-2">
                        <h5>‚è±Ô∏è Holding Period</h5>
                        <div class="metric-value" id="riskHolding">0 days</div>
                        <small>Average</small>
                    </div>
                    <div class="col-md-2">
                        <h5>üé≤ Consistency</h5>
                        <div class="metric-value" id="riskConsistency">0%</div>
                        <small>Monthly Performance</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let charts = {};

        async function runBacktest() {
            const symbol = document.getElementById('stockSelect').value;
            const strategy = document.getElementById('strategySelect').value;
            const period = document.getElementById('periodSelect').value;
            const capital = document.getElementById('initialCapital').value;

            showLoadingState();

            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, strategy, period, capital })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                updateAllCharts(data);
                updateMetrics(data.metrics);
                updateTradeTable(data);
                updateRiskAnalysis(data);

            } catch (error) {
                showError(error.message);
            }
        }

        function updateAllCharts(data) {
            createPriceChart(data.price_data);
            createRsiGauge(data.price_data);
            createStrategyChart(data.chart_data);
            createReturnsChart(data.price_data);
            createPieChart();
            createBarChart();
        }

        function createPriceChart(priceData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (charts.priceChart) charts.priceChart.destroy();

            charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: priceData.dates,
                    datasets: [
                        {
                            label: 'Stock Price (‚Çπ)',
                            data: priceData.prices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'SMA 20',
                            data: priceData.sma_20,
                            borderColor: '#28a745',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        function createRsiGauge(priceData) {
            const ctx = document.getElementById('rsiGaugeChart').getContext('2d');
            if (charts.rsiGauge) charts.rsiGauge.destroy();

            const currentRsi = priceData.rsi[priceData.rsi.length - 1];
            const rsiLevel = currentRsi < 30 ? 'Oversold' : currentRsi > 70 ? 'Overbought' : 'Neutral';
            const rsiColor = currentRsi < 30 ? '#28a745' : currentRsi > 70 ? '#dc3545' : '#ffc107';

            charts.rsiGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [currentRsi, 100 - currentRsi],
                        backgroundColor: [rsiColor, '#e9ecef'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: { 
                            display: true, 
                            text: `RSI: ${currentRsi.toFixed(1)}`,
                            color: rsiColor,
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
        }

        function createStrategyChart(chartData) {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            if (charts.strategyChart) charts.strategyChart.destroy();

            charts.strategyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [
                        {
                            label: 'Buy & Hold',
                            data: chartData.market,
                            borderColor: '#6c757d',
                            tension: 0.4
                        },
                        {
                            label: 'Trading Strategy',
                            data: chartData.strategy,
                            borderColor: '#667eea',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createReturnsChart(priceData) {
            const ctx = document.getElementById('returnsChart').getContext('2d');
            if (charts.returnsChart) charts.returnsChart.destroy();

            // Calculate daily returns
            const returns = [];
            for (let i = 1; i < priceData.prices.length; i++) {
                const ret = ((priceData.prices[i] - priceData.prices[i-1]) / priceData.prices[i-1]) * 100;
                returns.push(ret);
            }

            // Create histogram data
            const histogram = {};
            returns.forEach(r => {
                const bucket = Math.floor(r / 1) * 1; // 1% buckets
                histogram[bucket] = (histogram[bucket] || 0) + 1;
            });

            charts.returnsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(histogram).map(k => k + '%'),
                    datasets: [{
                        label: 'Frequency',
                        data: Object.values(histogram),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createPieChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            if (charts.pieChart) charts.pieChart.destroy();

            charts.pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Winning Trades', 'Losing Trades', 'Break-even'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function createBarChart() {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (charts.barChart) charts.barChart.destroy();

            charts.barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Monthly Return %',
                        data: [2.5, 3.2, -1.5, 4.1, 2.8, 3.5],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateTradeTable(data) {
            const tbody = document.getElementById('tradeTableBody');
            const trades = [
                { date: data.price_data.dates[20], signal: 'BUY', price: data.price_data.prices[20], rsi: data.price_data.rsi[20], return: 2.1 },
                { date: data.price_data.dates[40], signal: 'SELL', price: data.price_data.prices[40], rsi: data.price_data.rsi[40], return: -0.8 },
                { date: data.price_data.dates[60], signal: 'BUY', price: data.price_data.prices[60], rsi: data.price_data.rsi[60], return: 3.5 },
                { date: data.price_data.dates[80], signal: 'SELL', price: data.price_data.prices[80], rsi: data.price_data.rsi[80], return: 1.2 }
            ];

            tbody.innerHTML = trades.map(trade => `
                <tr>
                    <td>${trade.date}</td>
                    <td><span class="badge ${trade.signal === 'BUY' ? 'bg-success' : 'bg-danger'}">${trade.signal}</span></td>
                    <td>‚Çπ${trade.price.toFixed(2)}</td>
                    <td>${trade.rsi.toFixed(1)}</td>
                    <td>${trade.rsi < 30 ? 'üü¢ Oversold' : trade.rsi > 70 ? 'üî¥ Overbought' : 'üü° Neutral'}</td>
                    <td class="${trade.return >= 0 ? 'text-success' : 'text-danger'}">${trade.return >= 0 ? '+' : ''}${trade.return}%</td>
                </tr>
            `).join('');
        }

        function updateRiskAnalysis(data) {
            document.getElementById('riskVolatility').textContent = data.metrics.volatility + '%';
            document.getElementById('riskWinRate').textContent = '65%';
            document.getElementById('riskProfitFactor').textContent = '1.8';
            document.getElementById('riskExpectancy').textContent = '0.8%';
            document.getElementById('riskHolding').textContent = '20 days';
            document.getElementById('riskConsistency').textContent = '75%';
        }

        function updateMetrics(metrics) {
            const returnElem = document.getElementById('metricReturn');
            returnElem.textContent = `${metrics.total_return}%`;
            returnElem.className = `metric-value ${metrics.total_return >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('metricSharpe').textContent = metrics.sharpe_ratio;
            document.getElementById('metricDrawdown').textContent = `${metrics.max_drawdown}%`;
            document.getElementById('metricFinal').textContent = `‚Çπ${metrics.final_value}`;
        }

        function showLoadingState() {
            document.getElementById('tradeTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center">üîÑ Running backtest...</td></tr>';
        }

        function showError(message) {
            document.getElementById('tradeTableBody').innerHTML = 
                `<tr><td colspan="6" class="text-center text-danger">‚ùå Error: ${message}</td></tr>`;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            runBacktest();
        });
    </script>
</body>
</html>
